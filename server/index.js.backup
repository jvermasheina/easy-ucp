// Load environment variables FIRST
import './init-env.js';

// Initialize Sentry for error monitoring (production only)
import * as Sentry from '@sentry/node';

if (process.env.NODE_ENV === 'production' && process.env.SENTRY_DSN) {
  Sentry.init({
    dsn: process.env.SENTRY_DSN,
    environment: process.env.NODE_ENV || 'production',
    tracesSampleRate: 0.1, // 10% of transactions for performance monitoring
    // Ignore common errors that don't need tracking
    ignoreErrors: [
      'ECONNRESET',
      'ETIMEDOUT',
      'ENOTFOUND',
      'Invalid OAuth callback'
    ],
    beforeSend(event, hint) {
      // Don't send events with sensitive data
      if (event.request?.headers?.authorization) {
        delete event.request.headers.authorization;
      }
      return event;
    }
  });
  console.log('âœ… Sentry error monitoring enabled');
}

import { fileURLToPath } from 'url';
import path from 'path';

// Get directory paths
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import compression from 'compression';
import cookieParser from 'cookie-parser';
import session from 'express-session';
import shopify from './config/shopify.js';
import apiRoutes from './routes/api.js';
import productRoutes from './routes/products.js';
import shopifyAuth from './routes/shopify-auth.js';
import proxyRoutes from './routes/proxy.js';
import webhookRoutes from './routes/webhooks.js';
import { authRateLimiter, apiRateLimiter, proxyRateLimiter } from './middleware/rate-limit.js';

const app = express();
const PORT = process.env.PORT || 3000;

// Validate required environment variables
const REQUIRED_ENV_VARS = [
  'SHOPIFY_API_KEY',
  'SHOPIFY_API_SECRET',
  'SHOPIFY_HOST_NAME',
  'SESSION_SECRET',
  'SUPABASE_URL',
  'SUPABASE_SERVICE_ROLE_KEY',
  'ANTHROPIC_API_KEY'
];

const PRODUCTION_ONLY = ['SHOPIFY_HOST_NAME', 'SESSION_SECRET'];

function validateEnvironment() {
  const missing = [];

  for (const varName of REQUIRED_ENV_VARS) {
    if (!process.env[varName]) {
      // Allow some vars to be optional in development
      if (process.env.NODE_ENV === 'production' || !PRODUCTION_ONLY.includes(varName)) {
        missing.push(varName);
      }
    }
  }

  if (missing.length > 0) {
    console.error('âŒ FATAL: Missing required environment variables:');
    missing.forEach(v => console.error(`   - ${v}`));
    console.error('\nSet these in your .env file or environment.');
    process.exit(1);
  }

  // Validate SESSION_SECRET strength in production
  if (process.env.NODE_ENV === 'production' && process.env.SESSION_SECRET) {
    if (process.env.SESSION_SECRET.length < 32) {
      console.error('âŒ FATAL: SESSION_SECRET must be at least 32 characters in production');
      process.exit(1);
    }
  }

  console.log('âœ… Environment validation passed');
}

validateEnvironment();

// Trust Railway's proxy for secure cookies and HTTPS
app.set('trust proxy', 1);

// Sentry request handler - MUST be before all other middleware
if (process.env.NODE_ENV === 'production' && process.env.SENTRY_DSN && Sentry?.Handlers?.requestHandler) {
  app.use(Sentry.Handlers.requestHandler());
}

// Middleware
app.use(helmet({
  frameguard: false, // Disable X-Frame-Options - we use CSP frame-ancestors instead
  contentSecurityPolicy: process.env.NODE_ENV === 'production' ? {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: [
        "'self'",
        "https://cdn.shopify.com"
      ],
      styleSrc: [
        "'self'",
        "'unsafe-inline'", // Still needed for Polaris inline styles
        "https://cdn.shopify.com"
      ],
      imgSrc: [
        "'self'",
        "data:",
        "blob:",
        "https://cdn.shopify.com",
        "https://*.shopify.com"
      ],
      connectSrc: [
        "'self'",
        "https://*.myshopify.com"
      ],
      frameSrc: ["'none'"], // Not embedded
      frameAncestors: ["'none'"], // Not embedded
      fontSrc: [
        "'self'",
        "data:",
        "https://cdn.shopify.com"
      ],
      objectSrc: ["'none'"],
      upgradeInsecureRequests: []
    }
  } : false, // Disable CSP in development for easier debugging
  crossOriginEmbedderPolicy: false,
  crossOriginResourcePolicy: { policy: "cross-origin" }
}));
app.use(compression());

// Selective CORS configuration
const adminCors = cors(); // Wide open for admin routes (authenticated anyway)
const proxyCors = cors({
  origin: /\.myshopify\.com$/,
  methods: ['GET'],
  credentials: false
});

app.use(cookieParser()); // Required for Shopify OAuth when isEmbeddedApp: false

// Session middleware - Required for OAuth state management when isEmbeddedApp: false
app.use(session({
  secret: process.env.SESSION_SECRET, // Validated at startup
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: process.env.NODE_ENV === 'production', // HTTPS only in production
    httpOnly: true,
    maxAge: 24 * 60 * 60 * 1000, // 24 hours
    sameSite: 'lax' // Allow same-site navigation from Shopify callback
  }
}));

// Webhook routes - MUST come before express.json()
// Shopify webhooks need raw body for HMAC verification
app.use('/webhooks', express.raw({ type: 'application/json' }), webhookRoutes);

// JSON parsing for all other routes
app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ extended: true, limit: '50mb' }));

// Redirect root requests with shop parameter to OAuth (for Partner Dashboard "Install app" button)
app.get('/', async (req, res, next) => {
  const shopParam = req.query.shop;

  // If shop parameter exists, check if we need OAuth
  if (shopParam && shopParam.endsWith('.myshopify.com')) {
    // Check if valid session already exists
    if (shopify && shopify.config.sessionStorage) {
      const sessionId = shopify.session.getOfflineId(shopParam);
      const session = await shopify.config.sessionStorage.loadSession(sessionId);

      if (session && session.accessToken) {
        console.log('âœ… Valid session exists, loading React app for:', shopParam);
        // Session exists, continue to React app
        return next();
      }
    }

    // No session, redirect to OAuth
    console.log('ğŸ”€ Root request with shop parameter, redirecting to OAuth:', shopParam);
    return res.redirect(`/auth/shopify?shop=${shopParam}`);
  }

  // Otherwise continue to React app
  next();
});

// Health check endpoint
app.get('/api/health', (req, res) => {
  res.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    environment: process.env.NODE_ENV
  });
});

// Config diagnostic endpoint (for debugging)
app.get('/api/config', (req, res) => {
  const shopifyConfigured = !!(process.env.SHOPIFY_API_KEY && process.env.SHOPIFY_API_SECRET);
  const supabaseConfigured = !!(process.env.SUPABASE_URL && process.env.SUPABASE_SERVICE_ROLE_KEY);

  res.json({
    shopify: {
      configured: shopifyConfigured,
      hasApiKey: !!process.env.SHOPIFY_API_KEY,
      hasApiSecret: !!process.env.SHOPIFY_API_SECRET,
      hasScopes: !!process.env.SHOPIFY_SCOPES,
      hostName: process.env.SHOPIFY_HOST_NAME || 'NOT SET',
      nodeEnv: process.env.NODE_ENV
    },
    supabase: {
      configured: supabaseConfigured,
      hasUrl: !!process.env.SUPABASE_URL,
      hasServiceKey: !!process.env.SUPABASE_SERVICE_ROLE_KEY
    },
    anthropic: {
      hasApiKey: !!process.env.ANTHROPIC_API_KEY
    },
    ready: shopifyConfigured && supabaseConfigured
  });
});

// Shopify OAuth routes
app.use('/auth', authRateLimiter, adminCors, shopifyAuth);

// API routes
app.use('/api', apiRateLimiter, adminCors, apiRoutes);
app.use('/api', apiRateLimiter, adminCors, productRoutes);

// Public proxy routes (for storefront widget) - Restricted to Shopify domains
app.use('/proxy', proxyRateLimiter, proxyCors, proxyRoutes);

// Serve React client in production
if (process.env.NODE_ENV === 'production') {
  const clientBuildPath = path.join(__dirname, '../client/dist');
  app.use(express.static(clientBuildPath));

  app.get('*', (req, res) => {
    res.sendFile(path.join(clientBuildPath, 'index.html'));
  });
}

// Sentry error handler - MUST be after routes but before other error handlers
if (process.env.NODE_ENV === 'production' && process.env.SENTRY_DSN && Sentry?.Handlers?.errorHandler) {
  app.use(Sentry.Handlers.errorHandler());
}

// Error handling middleware
app.use((err, req, res, next) => {
  console.error('Error:', err);
  res.status(err.status || 500).json({
    error: {
      message: err.message || 'Internal server error',
      ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
    }
  });
});

// Start server
// Bind to 0.0.0.0 to accept connections from Railway's proxy
const HOST = process.env.HOST || '0.0.0.0';
app.listen(PORT, HOST, () => {
  console.log(`ğŸš€ Server running on ${HOST}:${PORT}`);
  console.log(`ğŸ“ Environment: ${process.env.NODE_ENV}`);
  console.log(`ğŸ”— API Health: http://${HOST}:${PORT}/api/health`);
});

export default app;
